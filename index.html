<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æºæ°ç‰©èª ç¾ä»£èªè¨³ãƒ†ã‚¹ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #ddd;
            margin-top: 20px;
        }

        .footer-link {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .footer-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .footer p {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .content {
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-btn:hover {
            background: #e9ecef;
        }

        .mode-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .radio-option {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
        }

        .radio-option label {
            cursor: pointer;
            display: block;
            margin: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }

        .original-text {
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 15px;
            color: #333;
            white-space: pre-wrap;
        }

        .translation-text {
            font-size: 16px;
            line-height: 1.7;
            color: #495057;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
        }

        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .answer-btn {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .answer-btn.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .answer-btn.partial {
            background: #ffc107;
            color: white;
            border-color: #ffc107;
        }

        .answer-btn.wrong {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .choice-buttons {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .choice-btn {
            padding: 15px 15px 15px 45px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .choice-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .choice-btn.selected {
            border-color: #667eea;
            background: #e7f1ff;
        }

        .choice-btn.correct {
            border-color: #28a745;
            background: #d4edda;
            position: relative;
        }

        .choice-btn.correct::before {
            content: 'â—‹';
            position: absolute;
            left: 10px;
            font-size: 24px;
            color: #28a745;
            font-weight: bold;
        }

        .choice-btn.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            position: relative;
        }

        .choice-btn.incorrect::before {
            content: 'Ã—';
            position: absolute;
            left: 10px;
            font-size: 24px;
            color: #dc3545;
            font-weight: bold;
        }

        /* æ­£è§£æ¼”å‡ºç”¨ */
        @keyframes correctAnimation {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes incorrectAnimation {
            0% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-10px);
            }
            75% {
                transform: translateX(10px);
            }
            100% {
                transform: translateX(0);
            }
        }

        @keyframes confetti {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            pointer-events: none;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-score {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .stat-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        /* å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ */
        .reading-item {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .reading-original {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .reading-translation-container {
            position: relative;
        }

        .reading-translation {
            font-size: 15px;
            line-height: 1.7;
            color: #495057;
            padding: 10px;
            background: #e7f1ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .reading-translation.hidden-translation {
            display: none;
        }

        .show-translation-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .show-translation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        /* ç”¨èªãƒªãƒ³ã‚¯ç”¨ */
        .term-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.3s;
        }

        .term-link:hover {
            color: #764ba2;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            font-size: 16px;
            line-height: 1.8;
            color: #555;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .btn {
                font-size: 16px;
            }

            .original-text {
                font-size: 16px;
            }
        }
    </style>
    <script src="genji_data.js"></script>
    <script src="genji_term_definitions.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æºæ°ç‰©èª ç¾ä»£èªè¨³ãƒ†ã‚¹ãƒˆ</h1>
            <p>å¤æ–‡ã®ç†è§£ã‚’æ·±ã‚ã‚ˆã†</p>
        </div>

        <div class="content">
            <!-- ãƒˆãƒƒãƒ—ç”»é¢ -->
            <div id="top-screen" class="screen active">
                <div class="setting-group">
                    <label>ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="mode-buttons" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="mode-btn selected" data-mode="flashcard">
                            <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“–</div>
                            <div>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</div>
                        </div>
                        <div class="mode-btn" data-mode="quiz">
                            <div style="font-size: 24px; margin-bottom: 5px;">âœï¸</div>
                            <div>4æŠã‚¯ã‚¤ã‚º</div>
                        </div>
                        <div class="mode-btn" data-mode="reading">
                            <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“š</div>
                            <div>å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</div>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <label for="volume-select">å·»ã‚’é¸æŠ</label>
                    <select id="volume-select">
                        <option value="">å…¨å·»ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ </option>
                    </select>
                </div>

                <div class="setting-group">
                    <label>å‡ºé¡Œæ–¹æ³•</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="order-random" name="order" value="random" checked>
                            <label for="order-random">ãƒ©ãƒ³ãƒ€ãƒ </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="order-sequential" name="order" value="sequential">
                            <label for="order-sequential">é †ç•ª</label>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <label for="question-count">å•é¡Œæ•°</label>
                    <input type="number" id="question-count" min="1" value="10" placeholder="å•é¡Œæ•°ã‚’å…¥åŠ›">
                </div>

                <div class="setting-group" id="review-mode-group" style="display: none;">
                    <label>
                        <input type="checkbox" id="review-mode">
                        å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼ˆé–“é•ãˆãŸå•é¡Œã®ã¿ï¼‰
                    </label>
                </div>

                <button class="btn" onclick="startTest()">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
                <button class="btn btn-secondary" onclick="showHistory()" style="margin-top: 10px;">å­¦ç¿’å±¥æ­´ã‚’è¦‹ã‚‹</button>
            </div>

            <!-- ãƒ†ã‚¹ãƒˆç”»é¢ -->
            <div id="test-screen" class="screen">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <span id="question-number">å•é¡Œ 1/10</span>
                        <span id="volume-name">æ¡å£º</span>
                    </div>

                    <div id="context-before" style="font-size: 14px; color: #888; margin-bottom: 10px; font-style: italic;"></div>

                    <div class="original-text" id="original-text"></div>

                    <div id="context-after" style="font-size: 14px; color: #888; margin-top: 10px; font-style: italic;"></div>

                    <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ -->
                    <div id="flashcard-controls" class="hidden">
                        <button class="btn" onclick="showAnswer()">ç­”ãˆã‚’è¡¨ç¤º</button>

                        <div id="answer-section" class="hidden">
                            <div id="context-translation-before" style="font-size: 13px; color: #888; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;"></div>

                            <div class="translation-text" id="translation-text"></div>

                            <div id="context-translation-after" style="font-size: 13px; color: #888; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;"></div>

                            <div class="answer-buttons">
                                <button class="answer-btn correct" onclick="answerQuestion('correct')">â—‹<br>ã§ããŸ</button>
                                <button class="answer-btn partial" onclick="answerQuestion('partial')">â–³<br>å¾®å¦™</button>
                                <button class="answer-btn wrong" onclick="answerQuestion('wrong')">Ã—<br>ã§ããš</button>
                            </div>
                        </div>
                    </div>

                    <!-- 4æŠã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ç”¨ -->
                    <div id="quiz-controls" class="hidden">
                        <div class="choice-buttons" id="choice-buttons"></div>
                        <button class="btn" id="submit-answer" onclick="submitQuizAnswer()" style="margin-top: 15px;">å›ç­”ã™ã‚‹</button>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="quitTest()">ãƒ†ã‚¹ãƒˆä¸­æ­¢</button>
            </div>

            <!-- å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ç”»é¢ -->
            <div id="reading-screen" class="screen">
                <div class="progress-bar">
                    <div class="progress-fill" id="reading-progress-fill"></div>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <span id="reading-position">1/20</span>
                        <span id="reading-volume-name">æ¡å£º</span>
                    </div>

                    <div id="reading-content" style="max-height: 60vh; overflow-y: auto;">
                        <!-- åŸæ–‡ã¨ç¾ä»£èªè¨³ãŒäº¤äº’ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" onclick="showAllTranslations()" style="flex: 1;">ã™ã¹ã¦è¡¨ç¤º</button>
                        <button class="btn" onclick="hideAllTranslations()" style="flex: 1; background: #6c757d;">ã™ã¹ã¦éè¡¨ç¤º</button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="prevReadingPage()" id="prev-reading-btn" style="flex: 1;">å‰ã¸</button>
                    <button class="btn" onclick="nextReadingPage()" id="next-reading-btn" style="flex: 1;">æ¬¡ã¸</button>
                </div>
                <button class="btn btn-secondary" onclick="quitReading()" style="margin-top: 10px;">å­¦ç¿’çµ‚äº†</button>
            </div>

            <!-- çµæœç”»é¢ -->
            <div id="result-screen" class="screen">
                <div class="result-card">
                    <h2>ãƒ†ã‚¹ãƒˆçµæœ</h2>
                    <div class="result-score" id="result-score">85%</div>

                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-value" style="color: #28a745;" id="correct-count">8</div>
                            <div class="stat-label">æ­£è§£</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #ffc107;" id="partial-count">1</div>
                            <div class="stat-label">éƒ¨åˆ†çš„</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #dc3545;" id="wrong-count">1</div>
                            <div class="stat-label">ä¸æ­£è§£</div>
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="reviewWrongAnswers()" id="review-btn">é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’</button>
                <button class="btn" onclick="restartTest()">åŒã˜è¨­å®šã§ã‚‚ã†ä¸€åº¦</button>
                <button class="btn btn-secondary" onclick="backToTop()">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ç”¨èªè§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="term-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-term-title">ç”¨èªè§£èª¬</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-term-body">
                èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="footer">
        <a href="https://github.com/Nishi-Taiga/Genji_test/issues/new/choose" target="_blank" class="footer-link">ğŸ“ å•é¡Œå ±å‘Šãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</a>
        <p>ãƒã‚°å ±å‘Šã€æ©Ÿèƒ½è¦æœ›ã€è³ªå•ãªã©ãŠæ°—è»½ã«ã©ã†ã</p>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allData = genjiData; // å¤–éƒ¨JSãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
        let currentTest = {
            mode: 'flashcard',
            questions: [],
            currentIndex: 0,
            results: []
        };
        let history = JSON.parse(localStorage.getItem('genjiTestHistory') || '[]');
        let selectedChoice = null;

        // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
        function loadData() {
            console.log(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${allData.length} ä»¶`);
            populateVolumeSelect();
            checkReviewMode();
        }

        // å·»é¸æŠã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ä½œæˆ
        function populateVolumeSelect() {
            const select = document.getElementById('volume-select');

            // é‡è¤‡ã‚’é™¤å»ã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå·»ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const volumeMap = new Map();
            allData.forEach(d => {
                if (!volumeMap.has(d.volumeNum)) {
                    volumeMap.set(d.volumeNum, d.volumeName);
                }
            });

            // å·»ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
            const volumes = Array.from(volumeMap.entries())
                .map(([num, name]) => ({num, name}))
                .sort((a, b) => a.num - b.num);

            volumes.forEach(v => {
                const option = document.createElement('option');
                option.value = v.num;
                option.textContent = `${v.num}. ${v.name}`;
                select.appendChild(option);
            });
        }

        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
        function checkReviewMode() {
            const wrongAnswers = history.filter(h => h.result === 'wrong');
            if (wrongAnswers.length > 0) {
                document.getElementById('review-mode-group').style.display = 'block';
            }
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                currentTest.mode = this.dataset.mode;
            });
        });

        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
        document.querySelectorAll('.radio-option').forEach(option => {
            option.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;

                document.querySelectorAll('.radio-option').forEach(o => {
                    o.style.background = '#f8f9fa';
                    o.style.color = '#333';
                    o.style.borderColor = '#ddd';
                });

                this.style.background = '#667eea';
                this.style.color = 'white';
                this.style.borderColor = '#667eea';
            });
        });

        // ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startTest() {
            const volumeNum = document.getElementById('volume-select').value;
            const order = document.querySelector('input[name="order"]:checked').value;
            const count = parseInt(document.getElementById('question-count').value);
            const reviewMode = document.getElementById('review-mode').checked;

            if (!count || count < 1) {
                alert('å•é¡Œæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å•é¡Œãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
            let questions = [];

            if (reviewMode) {
                const wrongIds = history.filter(h => h.result === 'wrong').map(h => h.id);
                questions = allData.filter((d, i) => wrongIds.includes(i));
            } else if (volumeNum) {
                questions = allData.filter(d => d.volumeNum === parseInt(volumeNum));
            } else {
                questions = [...allData];
            }

            // ç©ºãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–
            questions = questions.filter(q => q.original && q.translation);

            if (questions.length === 0) {
                alert('è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // å‡ºé¡Œé †åº
            if (order === 'random') {
                shuffleArray(questions);
            }

            // å•é¡Œæ•°ã®åˆ¶é™
            questions = questions.slice(0, Math.min(count, questions.length));

            currentTest.questions = questions;
            currentTest.currentIndex = 0;
            currentTest.results = [];

            // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            if (currentTest.mode === 'reading') {
                startReadingMode();
            } else {
                showScreen('test-screen');
                showQuestion();
            }
        }

        // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        let readingPageSize = 10; // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºæ•°
        let readingCurrentPage = 0;

        function startReadingMode() {
            readingCurrentPage = 0;
            showScreen('reading-screen');
            displayReadingPage();
        }

        // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸è¡¨ç¤º
        function displayReadingPage() {
            const startIdx = readingCurrentPage * readingPageSize;
            const endIdx = Math.min(startIdx + readingPageSize, currentTest.questions.length);
            const pageQuestions = currentTest.questions.slice(startIdx, endIdx);

            const content = document.getElementById('reading-content');
            content.innerHTML = '';

            pageQuestions.forEach((q, index) => {
                const globalIndex = startIdx + index;
                const item = document.createElement('div');
                item.className = 'reading-item';

                // åŸæ–‡ï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰
                const original = document.createElement('div');
                original.className = 'reading-original';
                original.innerHTML = createOriginalWithLinks(q.original, q.links);

                // ç¾ä»£èªè¨³ã‚³ãƒ³ãƒ†ãƒŠ
                const transContainer = document.createElement('div');
                transContainer.className = 'reading-translation-container';

                // ç¾ä»£èªè¨³è¡¨ç¤ºãƒœã‚¿ãƒ³
                const showBtn = document.createElement('button');
                showBtn.className = 'show-translation-btn';
                showBtn.textContent = 'ç¾ä»£èªè¨³ã‚’è¡¨ç¤º';
                showBtn.onclick = () => toggleTranslation(globalIndex);

                // ç¾ä»£èªè¨³
                const translation = document.createElement('div');
                translation.className = 'reading-translation hidden-translation';
                translation.id = `translation-${globalIndex}`;
                translation.textContent = q.translation;

                transContainer.appendChild(showBtn);
                transContainer.appendChild(translation);

                item.appendChild(original);
                item.appendChild(transContainer);
                content.appendChild(item);
            });

            // é€²æ—ã¨ãƒœã‚¿ãƒ³ã®æ›´æ–°
            const totalPages = Math.ceil(currentTest.questions.length / readingPageSize);
            document.getElementById('reading-position').textContent = `ãƒšãƒ¼ã‚¸ ${readingCurrentPage + 1}/${totalPages}`;
            document.getElementById('reading-volume-name').textContent = pageQuestions[0].volumeName;
            document.getElementById('reading-progress-fill').style.width = `${((readingCurrentPage + 1) / totalPages) * 100}%`;

            // å‰ã¸ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
            document.getElementById('prev-reading-btn').disabled = readingCurrentPage === 0;
            document.getElementById('prev-reading-btn').style.opacity = readingCurrentPage === 0 ? '0.5' : '1';

            // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
            document.getElementById('next-reading-btn').disabled = endIdx >= currentTest.questions.length;
            document.getElementById('next-reading-btn').style.opacity = endIdx >= currentTest.questions.length ? '0.5' : '1';
        }

        // ç¾ä»£èªè¨³ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleTranslation(index) {
            const translation = document.getElementById(`translation-${index}`);
            const container = translation.parentElement;
            const button = container.querySelector('.show-translation-btn');

            if (translation.classList.contains('hidden-translation')) {
                translation.classList.remove('hidden-translation');
                button.textContent = 'ç¾ä»£èªè¨³ã‚’éè¡¨ç¤º';
            } else {
                translation.classList.add('hidden-translation');
                button.textContent = 'ç¾ä»£èªè¨³ã‚’è¡¨ç¤º';
            }
        }

        // ã™ã¹ã¦ã®ç¾ä»£èªè¨³ã‚’è¡¨ç¤º
        function showAllTranslations() {
            document.querySelectorAll('.reading-translation').forEach(trans => {
                trans.classList.remove('hidden-translation');
            });
            document.querySelectorAll('.show-translation-btn').forEach(btn => {
                btn.textContent = 'ç¾ä»£èªè¨³ã‚’éè¡¨ç¤º';
            });
        }

        // ã™ã¹ã¦ã®ç¾ä»£èªè¨³ã‚’éè¡¨ç¤º
        function hideAllTranslations() {
            document.querySelectorAll('.reading-translation').forEach(trans => {
                trans.classList.add('hidden-translation');
            });
            document.querySelectorAll('.show-translation-btn').forEach(btn => {
                btn.textContent = 'ç¾ä»£èªè¨³ã‚’è¡¨ç¤º';
            });
        }

        // å‰ã®ãƒšãƒ¼ã‚¸ã¸
        function prevReadingPage() {
            if (readingCurrentPage > 0) {
                readingCurrentPage--;
                displayReadingPage();
                // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                document.getElementById('reading-content').scrollTop = 0;
            }
        }

        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸
        function nextReadingPage() {
            const totalPages = Math.ceil(currentTest.questions.length / readingPageSize);
            if (readingCurrentPage < totalPages - 1) {
                readingCurrentPage++;
                displayReadingPage();
                // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                document.getElementById('reading-content').scrollTop = 0;
            }
        }

        // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
        function quitReading() {
            if (confirm('å­¦ç¿’ã‚’çµ‚äº†ã—ã¾ã™ã‹?')) {
                backToTop();
            }
        }

        // åŸæ–‡ã«ãƒªãƒ³ã‚¯ã‚’åŸ‹ã‚è¾¼ã‚€
        function createOriginalWithLinks(originalText, linksJson) {
            if (!linksJson) {
                return originalText;
            }

            try {
                const links = JSON.parse(linksJson);
                if (!links || links.length === 0) {
                    return originalText;
                }

                let result = originalText;

                // ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã®é•·ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆé•·ã„æ–¹ã‹ã‚‰ç½®æ›ã™ã‚‹ã“ã¨ã§éƒ¨åˆ†ä¸€è‡´ã‚’é˜²ãï¼‰
                const sortedLinks = links.sort((a, b) => b.text.length - a.text.length);

                sortedLinks.forEach(link => {
                    const escapedText = link.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(escapedText, 'g');

                    result = result.replace(regex, (match) => {
                        return `<span class="term-link" onclick="showTermModal('${link.text.replace(/'/g, "\\'")}', '${link.href}')">${match}</span>`;
                    });
                });

                return result;
            } catch (e) {
                console.error('ãƒªãƒ³ã‚¯è§£æã‚¨ãƒ©ãƒ¼:', e);
                return originalText;
            }
        }

        // ç”¨èªè§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showTermModal(termText, href) {
            const modal = document.getElementById('term-modal');
            const title = document.getElementById('modal-term-title');
            const body = document.getElementById('modal-term-body');

            title.textContent = termText;
            body.innerHTML = 'è§£èª¬ã‚’èª­ã¿è¾¼ã¿ä¸­...';

            modal.classList.add('active');

            // hrefã‹ã‚‰IDã‚’æŠ½å‡ºï¼ˆä¾‹: genji_term01.html#nyougo_koui â†’ nyougo_kouiï¼‰
            const termId = href.split('#')[1];

            // ç”¨èªå®šç¾©ã‚’å–å¾—
            if (typeof genjiTerms !== 'undefined' && termId && genjiTerms[termId]) {
                const term = genjiTerms[termId];

                body.innerHTML = `
                    <div style="line-height: 1.8;">
                        ${term.definition}
                    </div>
                `;
            } else {
                // å®šç¾©ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å…ƒã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
                const baseUrl = 'http://james.3zoku.com/genji/';
                const fullUrl = baseUrl + href;

                body.innerHTML = `
                    <p style="color: #dc3545;">â€» ã“ã®ç”¨èªã®è§£èª¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                    <p><strong>å‚ç…§å…ˆï¼š</strong><a href="${fullUrl}" target="_blank" style="color: #667eea; text-decoration: underline;">${href}</a></p>
                `;
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            const modal = document.getElementById('term-modal');
            modal.classList.remove('active');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('term-modal');
            if (e.target === modal) {
                closeModal();
            }
        });

        // å•é¡Œè¡¨ç¤º
        function showQuestion() {
            const question = currentTest.questions[currentTest.currentIndex];
            const total = currentTest.questions.length;
            const current = currentTest.currentIndex + 1;

            // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®å›ç­”ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const submitBtn = document.getElementById('submit-answer');
            if (submitBtn) {
                submitBtn.textContent = 'å›ç­”ã™ã‚‹';
                submitBtn.onclick = submitQuizAnswer;
            }

            document.getElementById('question-number').textContent = `å•é¡Œ ${current}/${total}`;
            document.getElementById('volume-name').textContent = question.volumeName;
            // åŸæ–‡ã‚’ãƒªãƒ³ã‚¯ä»˜ãã§è¡¨ç¤º
            document.getElementById('original-text').innerHTML = createOriginalWithLinks(question.original, question.links);
            document.getElementById('progress-fill').style.width = `${(current / total) * 100}%`;

            // å‰å¾Œã®æ–‡è„ˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
            const context = getContextSentences(question);

            // å‰ã®æ–‡ï¼ˆåŸæ–‡ï¼‰
            const contextBefore = document.getElementById('context-before');
            if (context.before) {
                contextBefore.textContent = `ï¼ˆå‰ã®æ–‡ï¼‰${context.before.original}`;
                contextBefore.style.display = 'block';
            } else {
                contextBefore.style.display = 'none';
            }

            // æ¬¡ã®æ–‡ï¼ˆåŸæ–‡ï¼‰
            const contextAfter = document.getElementById('context-after');
            if (context.after) {
                contextAfter.textContent = `ï¼ˆæ¬¡ã®æ–‡ï¼‰${context.after.original}`;
                contextAfter.style.display = 'block';
            } else {
                contextAfter.style.display = 'none';
            }

            // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®åˆ¶å¾¡ã‚’è¡¨ç¤º
            if (currentTest.mode === 'flashcard') {
                document.getElementById('flashcard-controls').classList.remove('hidden');
                document.getElementById('quiz-controls').classList.add('hidden');
                document.getElementById('answer-section').classList.add('hidden');
            } else {
                document.getElementById('flashcard-controls').classList.add('hidden');
                document.getElementById('quiz-controls').classList.remove('hidden');
                setupQuizChoices(question);
            }
        }

        // å‰å¾Œã®æ–‡ã‚’å–å¾—
        function getContextSentences(currentQuestion) {
            const result = {
                before: null,
                after: null
            };

            // å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç¾åœ¨ã®å•é¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
            const currentIndex = allData.findIndex(q =>
                q.volumeNum === currentQuestion.volumeNum &&
                q.sectionId === currentQuestion.sectionId &&
                q.sentenceNum === currentQuestion.sentenceNum &&
                q.original === currentQuestion.original
            );

            if (currentIndex === -1) return result;

            // åŒã˜å·»ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ–‡ã‚’æ¢ã™
            const sameSection = allData.filter(q =>
                q.volumeNum === currentQuestion.volumeNum &&
                q.sectionId === currentQuestion.sectionId
            ).sort((a, b) => a.sentenceNum - b.sentenceNum);

            const positionInSection = sameSection.findIndex(q => q.sentenceNum === currentQuestion.sentenceNum);

            // å‰ã®æ–‡
            if (positionInSection > 0) {
                result.before = sameSection[positionInSection - 1];
            } else if (positionInSection === 0 && sameSection.length > 1) {
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€åˆã®æ–‡ã®å ´åˆã¯æ¬¡ã®æ–‡ã‚’è¡¨ç¤º
                result.after = sameSection[1];
            }

            // æ¬¡ã®æ–‡
            if (positionInSection < sameSection.length - 1 && positionInSection >= 0) {
                result.after = sameSection[positionInSection + 1];
            } else if (positionInSection === sameSection.length - 1 && sameSection.length > 1) {
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€å¾Œã®æ–‡ã®å ´åˆã¯å‰ã®æ–‡ã‚’è¡¨ç¤º
                result.before = sameSection[positionInSection - 1];
            }

            return result;
        }

        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰: ç­”ãˆè¡¨ç¤º
        function showAnswer() {
            const question = currentTest.questions[currentTest.currentIndex];
            const context = getContextSentences(question);

            // ç¾åœ¨ã®æ–‡ã®ç¾ä»£èªè¨³
            document.getElementById('translation-text').textContent = question.translation;

            // å‰ã®æ–‡ã®ç¾ä»£èªè¨³
            const contextTransBefore = document.getElementById('context-translation-before');
            if (context.before) {
                contextTransBefore.textContent = `ï¼ˆå‰ã®æ–‡ã®è¨³ï¼‰${context.before.translation}`;
                contextTransBefore.style.display = 'block';
            } else {
                contextTransBefore.style.display = 'none';
            }

            // æ¬¡ã®æ–‡ã®ç¾ä»£èªè¨³
            const contextTransAfter = document.getElementById('context-translation-after');
            if (context.after) {
                contextTransAfter.textContent = `ï¼ˆæ¬¡ã®æ–‡ã®è¨³ï¼‰${context.after.translation}`;
                contextTransAfter.style.display = 'block';
            } else {
                contextTransAfter.style.display = 'none';
            }

            document.getElementById('answer-section').classList.remove('hidden');
        }

        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰: å›ç­”
        function answerQuestion(result) {
            const question = currentTest.questions[currentTest.currentIndex];
            const questionId = allData.indexOf(question);

            currentTest.results.push(result);

            // å±¥æ­´ã«ä¿å­˜
            history.push({
                id: questionId,
                volumeName: question.volumeName,
                result: result,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('genjiTestHistory', JSON.stringify(history));

            nextQuestion();
        }

        // æ–‡å­—åˆ—ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ï¼ˆãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ï¼‰
        function calculateSimilarity(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));

            for (let i = 0; i <= len1; i++) matrix[i][0] = i;
            for (let j = 0; j <= len2; j++) matrix[0][j] = j;

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j - 1] + cost
                    );
                }
            }

            const distance = matrix[len1][len2];
            const maxLen = Math.max(len1, len2);
            return 1 - (distance / maxLen); // 0-1ã®ç¯„å›²ã§é¡ä¼¼åº¦ã‚’è¿”ã™
        }

        // 4æŠã‚¯ã‚¤ã‚º: é¸æŠè‚¢ä½œæˆï¼ˆæ­£è§£ã«ä¼¼ãŸé¸æŠè‚¢ã‚’é¸ã¶ï¼‰
        function setupQuizChoices(correctQuestion) {
            const choicesContainer = document.getElementById('choice-buttons');
            choicesContainer.innerHTML = '';
            selectedChoice = null;

            // æ­£è§£ã®ç¾ä»£èªè¨³
            const correctAnswer = correctQuestion.translation;
            const choices = [correctAnswer];
            const usedTexts = new Set([correctAnswer]); // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨

            // ã™ã¹ã¦ã®å€™è£œã‹ã‚‰æ­£è§£ä»¥å¤–ã‚’æŠ½å‡º
            const candidates = allData.filter(q =>
                q.translation &&
                q.translation !== correctAnswer &&
                q.translation.length > 10 // çŸ­ã™ãã‚‹æ–‡ã¯é™¤å¤–
            );

            // å„å€™è£œã«é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’ä»˜ã‘ã‚‹
            const scoredCandidates = candidates.map(q => ({
                translation: q.translation,
                similarity: calculateSimilarity(correctAnswer, q.translation),
                lengthDiff: Math.abs(correctAnswer.length - q.translation.length)
            }));

            // é¡ä¼¼åº¦ãŒé«˜ãã€é•·ã•ãŒè¿‘ã„ã‚‚ã®ã‚’å„ªå…ˆ
            scoredCandidates.sort((a, b) => {
                // é¡ä¼¼åº¦ã‚’ä¸»è¦ãªåŸºæº–ã¨ã—ã€é•·ã•ã®å·®ã‚’è£œåŠ©çš„ã«ä½¿ã†
                const similarityDiff = b.similarity - a.similarity;
                if (Math.abs(similarityDiff) > 0.1) {
                    return similarityDiff;
                }
                return a.lengthDiff - b.lengthDiff;
            });

            // ä¸Šä½3ã¤ã‚’é¸æŠè‚¢ã¨ã—ã¦è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
            for (let i = 0; i < scoredCandidates.length && choices.length < 4; i++) {
                const translation = scoredCandidates[i].translation;
                if (!usedTexts.has(translation)) {
                    choices.push(translation);
                    usedTexts.add(translation);
                }
            }

            // é¸æŠè‚¢ãŒ4ã¤ã«æº€ãŸãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«è¿½åŠ 
            if (choices.length < 4) {
                const remaining = allData.filter(q =>
                    q.translation &&
                    !usedTexts.has(q.translation) &&
                    q.translation.length > 10
                );

                shuffleArray(remaining);

                while (choices.length < 4 && remaining.length > 0) {
                    const translation = remaining.shift().translation;
                    if (!usedTexts.has(translation)) {
                        choices.push(translation);
                        usedTexts.add(translation);
                    }
                }
            }

            // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            shuffleArray(choices);

            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
            choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';

                // ãƒ©ãƒ™ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†ã‘ã¦é…ç½®
                const label = document.createElement('span');
                label.style.position = 'absolute';
                label.style.left = '15px';
                label.style.fontWeight = 'bold';
                label.textContent = String.fromCharCode(65 + index);

                const text = document.createElement('span');
                text.textContent = choice;

                btn.appendChild(label);
                btn.appendChild(text);
                btn.onclick = () => selectChoice(index, choice);
                choicesContainer.appendChild(btn);
            });
        }

        // 4æŠã‚¯ã‚¤ã‚º: é¸æŠ
        function selectChoice(index, choice) {
            document.querySelectorAll('.choice-btn').forEach((btn, i) => {
                btn.classList.remove('selected');
                if (i === index) {
                    btn.classList.add('selected');
                }
            });
            selectedChoice = choice;
        }

        // 4æŠã‚¯ã‚¤ã‚º: å›ç­”é€ä¿¡
        function submitQuizAnswer() {
            if (selectedChoice === null) {
                alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„');
                return;
            }

            // ã™ã§ã«å›ç­”æ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            const submitBtn = document.getElementById('submit-answer');
            if (submitBtn.textContent === 'æ¬¡ã®å•é¡Œã¸') {
                return;
            }

            const question = currentTest.questions[currentTest.currentIndex];
            const correct = selectedChoice === question.translation;
            const questionId = allData.indexOf(question);

            // çµæœè¡¨ç¤º
            document.querySelectorAll('.choice-btn').forEach(btn => {
                // ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ï¼ˆãƒ©ãƒ™ãƒ«ä»¥å¤–ï¼‰
                const textSpan = btn.querySelector('span:last-child');
                const text = textSpan ? textSpan.textContent : btn.textContent;

                if (text === question.translation) {
                    btn.classList.add('correct');
                    // æ­£è§£ã®å ´åˆã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (correct) {
                        btn.style.animation = 'correctAnimation 0.5s ease';
                    }
                } else if (text === selectedChoice) {
                    btn.classList.add('incorrect');
                    // ä¸æ­£è§£ã®å ´åˆã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    btn.style.animation = 'incorrectAnimation 0.5s ease';
                }
                btn.onclick = null; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
            });

            // æ­£è§£ã®å ´åˆã€ç´™å¹é›ªæ¼”å‡º
            if (correct) {
                createConfetti();
            }

            const result = correct ? 'correct' : 'wrong';
            currentTest.results.push(result);

            // å±¥æ­´ã«ä¿å­˜
            history.push({
                id: questionId,
                volumeName: question.volumeName,
                result: result,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('genjiTestHistory', JSON.stringify(history));

            // æ¬¡ã®å•é¡Œã¸ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            submitBtn.textContent = 'æ¬¡ã®å•é¡Œã¸';
            submitBtn.onclick = nextQuestion;
        }

        // ç´™å¹é›ªæ¼”å‡º
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe'];
            const confettiCount = 30;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                confetti.style.animation = 'confetti ' + confetti.style.animationDuration + ' ease-out forwards';

                document.body.appendChild(confetti);

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å‰Šé™¤
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        // æ¬¡ã®å•é¡Œ
        function nextQuestion() {
            currentTest.currentIndex++;

            if (currentTest.currentIndex >= currentTest.questions.length) {
                showResult();
            } else {
                showQuestion();
            }
        }

        // çµæœè¡¨ç¤º
        function showResult() {
            const correctCount = currentTest.results.filter(r => r === 'correct').length;
            const partialCount = currentTest.results.filter(r => r === 'partial').length;
            const wrongCount = currentTest.results.filter(r => r === 'wrong').length;
            const total = currentTest.results.length;

            // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§ã¯éƒ¨åˆ†æ­£è§£ã‚’0.5ç‚¹ã¨ã—ã¦è¨ˆç®—
            let score;
            if (currentTest.mode === 'flashcard') {
                score = Math.round(((correctCount + partialCount * 0.5) / total) * 100);
            } else {
                score = Math.round((correctCount / total) * 100);
            }

            document.getElementById('result-score').textContent = `${score}%`;
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('partial-count').textContent = partialCount;
            document.getElementById('wrong-count').textContent = wrongCount;

            // å¾©ç¿’ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            if (wrongCount > 0) {
                document.getElementById('review-btn').style.display = 'block';
            } else {
                document.getElementById('review-btn').style.display = 'none';
            }

            showScreen('result-screen');
        }

        // é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’
        function reviewWrongAnswers() {
            document.getElementById('review-mode').checked = true;
            backToTop();
        }

        // åŒã˜è¨­å®šã§ã‚‚ã†ä¸€åº¦
        function restartTest() {
            currentTest.currentIndex = 0;
            currentTest.results = [];
            shuffleArray(currentTest.questions);
            showScreen('test-screen');
            showQuestion();
        }

        // ãƒ†ã‚¹ãƒˆä¸­æ­¢
        function quitTest() {
            if (confirm('ãƒ†ã‚¹ãƒˆã‚’ä¸­æ­¢ã—ã¾ã™ã‹?')) {
                backToTop();
            }
        }

        // ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
        function backToTop() {
            showScreen('top-screen');
            checkReviewMode();
        }

        // å­¦ç¿’å±¥æ­´è¡¨ç¤º
        function showHistory() {
            if (history.length === 0) {
                alert('ã¾ã å­¦ç¿’å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const recentHistory = history.slice(-20).reverse();
            let message = 'æœ€è¿‘ã®å­¦ç¿’å±¥æ­´:\n\n';

            recentHistory.forEach((h, i) => {
                const date = new Date(h.timestamp).toLocaleString('ja-JP');
                const resultIcon = h.result === 'correct' ? 'â—‹' : h.result === 'partial' ? 'â–³' : 'Ã—';
                message += `${resultIcon} ${h.volumeName} - ${date}\n`;
            });

            alert(message);
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // åˆæœŸåŒ–
        window.onload = loadData;
    </script>
</body>
</html>
